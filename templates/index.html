<!DOCTYPE html>
<html lang="en" class="h-full bg-slate-900">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ClinicXZ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@400;500;700&family=Playfair+Display:wght@700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Outfit', sans-serif; }
        h1, h2, h3, h4, h5, h6 { font-family: 'Playfair Display', serif; }
        [x-cloak] { display: none !important; }
    </style>
</head>
<body class="h-full text-slate-200" x-data="clinicApp()" x-cloak>

    <div x-show="notification.show" 
         class="fixed top-5 right-5 z-50 p-4 rounded-md text-white shadow-lg"
         :class="{ 'bg-green-500': notification.type === 'success', 'bg-red-500': notification.type === 'error' }"
         x-transition:enter="transition ease-out duration-300"
         x-transition:enter-start="opacity-0 transform translate-x-full"
         x-transition:enter-end="opacity-100 transform translate-x-0"
         x-transition:leave="transition ease-in duration-300"
         x-transition:leave-start="opacity-100 transform translate-x-0"
         x-transition:leave-end="opacity-0 transform translate-x-full">
        <p x-text="notification.message"></p>
    </div>

    <div x-show="!isAuthenticated" class="flex min-h-full items-center justify-center py-12 px-4 sm:px-6 lg:px-8">
        <div class="w-full max-w-md space-y-8">
            <div>
                <svg class="mx-auto h-12 w-auto text-purple-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M12 4.5v15m7.5-7.5h-15" /></svg>                  
                <h2 class="mt-6 text-center text-3xl font-bold tracking-tight text-white">Sign in to ClinicXZ</h2>
            </div>
            <form class="mt-8 space-y-6" @submit.prevent="login">
                <div class="space-y-4 rounded-md">
                    <div>
                        <label for="username" class="sr-only">Username</label>
                        <input id="username" type="text" x-model="credentials.username" required class="w-full bg-slate-800 border border-slate-700 text-white rounded-md p-3 focus:ring-2 focus:ring-purple-500 focus:border-purple-500 transition" placeholder="Username">
                    </div>
                    <div>
                        <label for="password" class="sr-only">Password</label>
                        <input id="password" type="password" x-model="credentials.password" required class="w-full bg-slate-800 border border-slate-700 text-white rounded-md p-3 focus:ring-2 focus:ring-purple-500 focus:border-purple-500 transition" placeholder="Password">
                    </div>
                </div>
                <div x-show="loginError" class="text-red-400 text-sm" x-text="loginError"></div>
                <div>
                    <button type="submit" class="group relative flex w-full justify-center px-4 py-3 rounded-md font-semibold transition-all duration-300 text-white bg-gradient-to-r from-purple-600 to-indigo-600 hover:from-purple-700 hover:to-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-offset-slate-900 focus:ring-purple-500 hover:shadow-lg hover:shadow-purple-500/40">
                        Sign in
                    </button>
                </div>
            </form>
        </div>
    </div>

    <div x-show="isAuthenticated">
        <aside :class="{ 'translate-x-0': sidebarOpen, '-translate-x-full': !sidebarOpen }" class="fixed top-0 left-0 z-40 w-64 h-screen transition-transform sm:translate-x-0 bg-slate-800 border-r border-slate-700">
            <div class="h-full px-3 py-4 overflow-y-auto">
                <a href="#" @click.prevent="setView('dashboard')" class="flex items-center ps-2.5 mb-5">
                    <svg class="h-8 w-auto text-purple-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M12 4.5v15m7.5-7.5h-15" /></svg>                      
                    <span class="self-center text-2xl font-semibold whitespace-nowrap text-white ml-2" style="font-family: 'Playfair Display', serif;">ClinicXZ</span>
                </a>
                <ul class="space-y-2 font-medium">
                    <li><a href="#" @click.prevent="setView('dashboard')" :class="{'bg-purple-600 text-white': currentView === 'dashboard', 'text-slate-300 hover:bg-slate-700': currentView !== 'dashboard'}" class="flex items-center p-2 rounded-lg group transition-colors"><span class="ms-3">Dashboard</span></a></li>
                    <li><a href="#" @click.prevent="setView('allPatients')" :class="{'bg-purple-600 text-white': currentView === 'allPatients', 'text-slate-300 hover:bg-slate-700': currentView !== 'allPatients'}" class="flex items-center p-2 rounded-lg group transition-colors"><span class="ms-3">All Patients</span></a></li>
                    <li><a href="#" @click.prevent="setView('addPatient')" :class="{'bg-purple-600 text-white': currentView === 'addPatient', 'text-slate-300 hover:bg-slate-700': currentView !== 'addPatient'}" class="flex items-center p-2 rounded-lg group transition-colors"><span class="ms-3">Add New Patient</span></a></li>
                    <li><a href="#" @click.prevent="setView('schedule')" :class="{'bg-purple-600 text-white': currentView === 'schedule', 'text-slate-300 hover:bg-slate-700': currentView !== 'schedule'}" class="flex items-center p-2 rounded-lg group transition-colors"><span class="ms-3">Schedule</span></a></li>
                </ul>
                <div class="absolute bottom-4 left-3 right-3">
                    <button @click="logout" class="w-full px-4 py-2 rounded-md font-semibold transition-all duration-200 bg-slate-700 text-slate-300 hover:bg-slate-600">Logout</button>
                </div>
            </div>
        </aside>

        <div class="sm:ml-64 p-4 md:p-6 lg:p-8">
            <div class="sm:hidden flex justify-between items-center mb-6">
                <button @click="sidebarOpen = !sidebarOpen" class="text-slate-300"><svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path></svg></button>
                <h1 class="text-xl font-bold" x-text="pageTitle"></h1>
            </div>

            <main x-show="currentView === 'dashboard'" x-init="if(isAuthenticated) getDashboardStats()">
                <h1 class="text-3xl font-bold text-white mb-8">Dashboard</h1>
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 mb-8">
                    <div class="bg-slate-800 p-6 rounded-lg border border-slate-700"><h3 class="text-slate-400 text-sm font-medium">Total Patients</h3><p class="text-3xl font-bold text-white" x-text="dashboard.total_patients"></p></div>
                    <div class="bg-slate-800 p-6 rounded-lg border border-slate-700"><h3 class="text-slate-400 text-sm font-medium">Upcoming Appointments</h3><p class="text-3xl font-bold text-white" x-text="dashboard.upcoming_appointments"></p></div>
                </div>
                <div>
                    <h2 class="text-2xl font-bold text-white mb-4">Recent Patient Visits</h2>
                    <div class="bg-slate-800 rounded-lg border border-slate-700">
                        <ul class="divide-y divide-slate-700">
                            <template x-for="visit in dashboard.recent_patient_visits" :key="visit.name"><li class="p-4 flex justify-between items-center"><span class="font-semibold" x-text="visit.name"></span><span class="text-sm text-slate-400" x-text="formatDate(visit.last_visit)"></span></li></template>
                            <template x-if="!dashboard.recent_patient_visits || dashboard.recent_patient_visits.length === 0"><li class="p-6 text-center text-slate-400">No recent visits found.</li></template>
                        </ul>
                    </div>
                </div>
            </main>

            <main x-show="currentView === 'allPatients'" x-init="if(isAuthenticated) getAllPatients()">
                <h1 class="text-3xl font-bold text-white mb-8">All Patients</h1>
                <div class="mb-6"><input type="text" x-model="patientSearch" placeholder="Search by name or phone..." class="w-full max-w-sm bg-slate-800 border border-slate-700 text-white rounded-md p-3 focus:ring-2 focus:ring-purple-500 focus:border-purple-500 transition"></div>
                <div class="bg-slate-800 rounded-lg border border-slate-700 overflow-x-auto">
                    <table class="w-full text-sm text-left text-slate-300">
                        <thead class="text-xs text-slate-400 uppercase bg-slate-700"><tr><th scope="col" class="px-6 py-3">Name</th><th scope="col" class="px-6 py-3">Phone</th><th scope="col" class="px-6 py-3">Core Reason</th><th scope="col" class="px-6 py-3 text-right">Actions</th></tr></thead>
                        <tbody>
                            <template x-for="patient in filteredPatients" :key="patient.id"><tr class="border-b border-slate-700 hover:bg-slate-700/50"><td class="px-6 py-4 font-medium text-white" x-text="patient.full_name"></td><td class="px-6 py-4" x-text="patient.phone_number"></td><td class="px-6 py-4" x-text="patient.core_reason"></td><td class="px-6 py-4 flex items-center justify-end gap-2"><button @click="viewPatient(patient.id)" class="px-3 py-1 rounded-md font-semibold transition-all duration-200 bg-slate-700 text-slate-300 hover:bg-slate-600 text-xs">View</button><button @click="confirmDeletePatient(patient.id, patient.full_name)" class="px-3 py-1 rounded-md font-semibold transition-all duration-200 bg-red-600 text-white hover:bg-red-700 text-xs">Delete</button></td></tr></template>
                             <template x-if="filteredPatients.length === 0"><tr><td colspan="4" class="text-center py-8 text-slate-400">No patients found.</td></tr></template>
                        </tbody>
                    </table>
                </div>
            </main>

            <main x-show="currentView === 'addPatient'">
                <h1 class="text-3xl font-bold text-white mb-8">Add New Patient</h1>
                <form @submit.prevent="addPatient()" class="space-y-8" x-if="editablePatient">
                    <div class="p-6 bg-slate-800 rounded-lg border border-slate-700 space-y-6">
                        <h3 class="text-xl font-bold text-white border-b border-slate-600 pb-3 mb-6">Personal Information</h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div><label class="block mb-2 text-sm font-medium">Full Name <span class="text-red-500">*</span></label><input type="text" x-model="editablePatient.full_name" required class="w-full bg-slate-900 border border-slate-700 text-white rounded-md p-3 focus:ring-2 focus:ring-purple-500 focus:border-purple-500 transition"></div>
                            <div><label class="block mb-2 text-sm font-medium">Phone Number <span class="text-red-500">*</span></label><input type="text" x-model="editablePatient.phone_number" required class="w-full bg-slate-900 border border-slate-700 text-white rounded-md p-3 focus:ring-2 focus:ring-purple-500 focus:border-purple-500 transition"></div>
                            <div><label class="block mb-2 text-sm font-medium">Age</label><input type="number" x-model.number="editablePatient.age" class="w-full bg-slate-900 border border-slate-700 text-white rounded-md p-3 focus:ring-2 focus:ring-purple-500 focus:border-purple-500 transition"></div>
                            <div><label class="block mb-2 text-sm font-medium">Place</label><input type="text" x-model="editablePatient.place" class="w-full bg-slate-900 border border-slate-700 text-white rounded-md p-3 focus:ring-2 focus:ring-purple-500 focus:border-purple-500 transition"></div>
                            <div><label class="block mb-2 text-sm font-medium">Father's Name</label><input type="text" x-model="editablePatient.father_name" class="w-full bg-slate-900 border border-slate-700 text-white rounded-md p-3 focus:ring-2 focus:ring-purple-500 focus:border-purple-500 transition"></div>
                            <div><label class="block mb-2 text-sm font-medium">School Class Studied</label><input type="text" x-model="editablePatient.school_class_studied" class="w-full bg-slate-900 border border-slate-700 text-white rounded-md p-3 focus:ring-2 focus:ring-purple-500 focus:border-purple-500 transition"></div>
                            <div><label class="block mb-2 text-sm font-medium">Madrasa Class/Level Studied</label><input type="text" x-model="editablePatient.madrasa_class_studied" class="w-full bg-slate-900 border border-slate-700 text-white rounded-md p-3 focus:ring-2 focus:ring-purple-500 focus:border-purple-500 transition"></div>
                        </div>
                    </div>
                     <div class="p-6 bg-slate-800 rounded-lg border border-slate-700 space-y-6">
                        <h3 class="text-xl font-bold text-white border-b border-slate-600 pb-3 mb-6">Marital & Family Status</h3>
                        <div class="flex items-center space-x-3"><input type="checkbox" id="add_is_married" x-model="editablePatient.is_married" class="h-4 w-4 rounded bg-slate-900 border-slate-700 text-purple-600 focus:ring-purple-500"><label for="add_is_married">Is Married?</label></div>
                        <div x-show="editablePatient.is_married" class="grid grid-cols-1 md:grid-cols-2 gap-6">
                             <div><label class="block mb-2 text-sm font-medium">Husband's Name</label><input type="text" x-model="editablePatient.husband_name" class="w-full bg-slate-900 border border-slate-700 text-white rounded-md p-3 focus:ring-2 focus:ring-purple-500 focus:border-purple-500 transition"></div>
                            <div><label class="block mb-2 text-sm font-medium">Husband's Job</label><input type="text" x-model="editablePatient.husband_job" class="w-full bg-slate-900 border border-slate-700 text-white rounded-md p-3 focus:ring-2 focus:ring-purple-500 focus:border-purple-500 transition"></div>
                        </div>
                        <div><label class="block mb-2 text-sm font-medium">Number of Kids</label><input type="number" x-model.number="editablePatient.kids_count" @input="updateKidsArray()" class="w-full max-w-xs bg-slate-900 border border-slate-700 text-white rounded-md p-3 focus:ring-2 focus:ring-purple-500 focus:border-purple-500 transition"></div>
                        <div x-show="editablePatient.kids_count > 0" class="space-y-3">
                            <h4 class="text-sm font-semibold text-slate-300">Kid Details</h4>
                            <template x-for="(kid, index) in editablePatient.kids" :key="index">
                                <div class="flex items-center gap-4 p-3 bg-slate-900/50 rounded-md">
                                    <span class="font-medium text-slate-300">Kid <span x-text="index + 1"></span>:</span>
                                    <select x-model="kid.sex" class="w-1/3 bg-slate-800 border border-slate-700 text-white rounded-md p-2 focus:ring-2 focus:ring-purple-500 focus:border-purple-500 transition"><option value="">Sex...</option><option value="Male">Male</option><option value="Female">Female</option></select>
                                    <input type="number" x-model.number="kid.age" placeholder="Age" class="w-1/3 bg-slate-800 border border-slate-700 text-white rounded-md p-2 focus:ring-2 focus:ring-purple-500 focus:border-purple-500 transition">
                                </div>
                            </template>
                        </div>
                    </div>
                     <div class="p-6 bg-slate-800 rounded-lg border border-slate-700 space-y-6">
                        <h3 class="text-xl font-bold text-white border-b border-slate-600 pb-3 mb-6">Clinical & Other Information</h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-x-8 gap-y-6">
                            <div class="space-y-4">
                                <div class="flex items-center space-x-3"><input type="checkbox" id="add_is_working" x-model="editablePatient.is_working" class="h-4 w-4 rounded bg-slate-900 border-slate-700 text-purple-600 focus:ring-purple-500"><label for="add_is_working">Is currently working?</label></div>
                                <div class="flex items-center space-x-3"><input type="checkbox" id="add_has_siblings" x-model="editablePatient.has_siblings" class="h-4 w-4 rounded bg-slate-900 border-slate-700 text-purple-600 focus:ring-purple-500"><label for="add_has_siblings">Has siblings?</label></div>
                                <div x-show="editablePatient.has_siblings" class="flex items-center space-x-3 ml-6"><input type="checkbox" id="add_siblings_have_issues" x-model="editablePatient.siblings_have_issues" class="h-4 w-4 rounded bg-slate-900 border-slate-700 text-purple-600 focus:ring-purple-500"><label for="add_siblings_have_issues">Do they have similar issues?</label></div>
                                <div class="flex items-center space-x-3"><input type="checkbox" id="add_is_genetic" x-model="editablePatient.is_genetic" class="h-4 w-4 rounded bg-slate-900 border-slate-700 text-purple-600 focus:ring-purple-500"><label for="add_is_genetic">Is it genetic?</label></div>
                                <div x-show="editablePatient.is_genetic" class="ml-6"><label class="block mb-2 text-sm font-medium">Name of relative with genetic link</label><input type="text" x-model="editablePatient.genetic_relative_name" class="w-full bg-slate-900 border border-slate-700 text-white rounded-md p-3 focus:ring-2 focus:ring-purple-500 focus:border-purple-500 transition"></div>
                            </div>
                            <div class="space-y-6">
                                <div><label class="block mb-2 text-sm font-medium">Core Reason (e.g., OCD, Anxiety)</label><input type="text" x-model="editablePatient.core_reason" class="w-full bg-slate-900 border border-slate-700 text-white rounded-md p-3 focus:ring-2 focus:ring-purple-500 focus:border-purple-500 transition"></div>
                                <div><label class="block mb-2 text-sm font-medium">When it started?</label><input type="text" x-model="editablePatient.when_it_started" class="w-full bg-slate-900 border border-slate-700 text-white rounded-md p-3 focus:ring-2 focus:ring-purple-500 focus:border-purple-500 transition"></div>
                                <div>
                                    <label class="block mb-2 text-sm font-medium">Previously sought help from?</label>
                                    <div class="space-y-3 mt-2">
                                        <div class="flex gap-4 flex-wrap"><label class="flex items-center gap-2"><input type="checkbox" value="Psychologist" x-model="editablePatient.previously_sought_help" class="h-4 w-4 rounded bg-slate-900 border-slate-700 text-purple-600 focus:ring-purple-500"> Psychologist</label><label class="flex items-center gap-2"><input type="checkbox" value="Psychiatrist" x-model="editablePatient.previously_sought_help" class="h-4 w-4 rounded bg-slate-900 border-slate-700 text-purple-600 focus:ring-purple-500"> Psychiatrist</label><label class="flex items-center gap-2"><input type="checkbox" value="Spiritual" x-model="editablePatient.previously_sought_help" class="h-4 w-4 rounded bg-slate-900 border-slate-700 text-purple-600 focus:ring-purple-500"> Spiritual</label></div>
                                        <div><label class="block mb-2 text-sm font-medium">Other:</label><input type="text" x-model="editablePatient.previously_sought_help_other" class="w-full bg-slate-900 border border-slate-700 text-white rounded-md p-3 focus:ring-2 focus:ring-purple-500 focus:border-purple-500 transition"></div>
                                    </div>
                                </div>
                                <div><label class="block mb-2 text-sm font-medium">Medicine Status</label><select x-model="editablePatient.medicine_status" class="w-full bg-slate-900 border border-slate-700 text-white rounded-md p-3 focus:ring-2 focus:ring-purple-500 focus:border-purple-500 transition"><option value="">Select...</option><option value="I did take medicine">I did take medicine</option><option value="I am taking medicine now">I am taking medicine now</option></select></div>
                                <div><label class="block mb-2 text-sm font-medium">Other Medications</label><input type="text" x-model="editablePatient.other_medications" class="w-full bg-slate-900 border border-slate-700 text-white rounded-md p-3 focus:ring-2 focus:ring-purple-500 focus:border-purple-500 transition"></div>
                                <div><label class="block mb-2 text-sm font-medium">Other Diseases</label><input type="text" x-model="editablePatient.other_diseases" class="w-full bg-slate-900 border border-slate-700 text-white rounded-md p-3 focus:ring-2 focus:ring-purple-500 focus:border-purple-500 transition"></div>
                            </div>
                        </div>
                    </div>
                    <div class="flex justify-end gap-4 pt-4">
                        <button type="button" @click="resetEditablePatient()" class="px-4 py-2 rounded-md font-semibold transition-all duration-200 bg-slate-700 text-slate-300 hover:bg-slate-600">Clear Form</button>
                        <button type="submit" class="px-6 py-2 rounded-md font-semibold transition-all duration-300 text-white bg-gradient-to-r from-purple-600 to-indigo-600 hover:from-purple-700 hover:to-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-offset-slate-900 focus:ring-purple-500 hover:shadow-lg hover:shadow-purple-500/40">Add Patient</button>
                    </div>
                </form>
            </main>

            <main x-show="currentView === 'patientDetail'">
                <template x-if="selectedPatient">
                    <div class="space-y-8">
                        
                        <div>
                            <button @click="setView('allPatients')" class="text-purple-400 hover:text-purple-300 mb-2">&larr; Back to All Patients</button>
                            <h1 class="text-3xl font-bold text-white" x-text="selectedPatient.full_name"></h1>
                            <p class="text-slate-400" x-text="selectedPatient.phone_number"></p>
                        </div>
                        <div class="border-b border-slate-700">
                            <nav class="-mb-px flex space-x-4" aria-label="Tabs">
                                <button @click="patientDetailTab = 'details'" :class="patientDetailTab === 'details' ? 'border-purple-500 text-purple-400' : 'border-transparent text-slate-400 hover:text-slate-300 hover:border-slate-400'" class="whitespace-nowrap py-3 px-1 border-b-2 font-medium text-sm">Details</button>
                                <button @click="patientDetailTab = 'issues'" :class="patientDetailTab === 'issues' ? 'border-purple-500 text-purple-400' : 'border-transparent text-slate-400 hover:text-slate-300 hover:border-slate-400'" class="whitespace-nowrap py-3 px-1 border-b-2 font-medium text-sm">Checklist</button>
                                <button @click="patientDetailTab = 'sessions'" :class="patientDetailTab === 'sessions' ? 'border-purple-500 text-purple-400' : 'border-transparent text-slate-400 hover:text-slate-300 hover:border-slate-400'" class="whitespace-nowrap py-3 px-1 border-b-2 font-medium text-sm">Sessions</button>
                                <button @click="patientDetailTab = 'progress'" :class="patientDetailTab === 'progress' ? 'border-purple-500 text-purple-400' : 'border-transparent text-slate-400 hover:text-slate-300 hover:border-slate-400'" class="whitespace-nowrap py-3 px-1 border-b-2 font-medium text-sm">Progress</button>
                            </nav>
                        </div>
                        
                        <div x-show="patientDetailTab === 'details'">
                            <form @submit.prevent="updatePatientDetails()" class="space-y-8" x-if="editablePatient">
                                <div class="p-6 bg-slate-800 rounded-lg border border-slate-700 space-y-6">
                                    <h3 class="text-xl font-bold text-white border-b border-slate-600 pb-3 mb-6">Personal Information</h3>
                                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                        <div><label class="block mb-2 text-sm font-medium">Full Name <span class="text-red-500">*</span></label><input type="text" x-model="editablePatient.full_name" required class="w-full bg-slate-900 border border-slate-700 text-white rounded-md p-3 focus:ring-2 focus:ring-purple-500 focus:border-purple-500 transition"></div>
                                        <div><label class="block mb-2 text-sm font-medium">Phone Number <span class="text-red-500">*</span></label><input type="text" x-model="editablePatient.phone_number" required class="w-full bg-slate-900 border border-slate-700 text-white rounded-md p-3 focus:ring-2 focus:ring-purple-500 focus:border-purple-500 transition"></div>
                                        <div><label class="block mb-2 text-sm font-medium">Age</label><input type="number" x-model.number="editablePatient.age" class="w-full bg-slate-900 border border-slate-700 text-white rounded-md p-3 focus:ring-2 focus:ring-purple-500 focus:border-purple-500 transition"></div>
                                        <div><label class="block mb-2 text-sm font-medium">Place</label><input type="text" x-model="editablePatient.place" class="w-full bg-slate-900 border border-slate-700 text-white rounded-md p-3 focus:ring-2 focus:ring-purple-500 focus:border-purple-500 transition"></div>
                                        <div><label class="block mb-2 text-sm font-medium">Father's Name</label><input type="text" x-model="editablePatient.father_name" class="w-full bg-slate-900 border border-slate-700 text-white rounded-md p-3 focus:ring-2 focus:ring-purple-500 focus:border-purple-500 transition"></div>
                                        <div><label class="block mb-2 text-sm font-medium">School Class Studied</label><input type="text" x-model="editablePatient.school_class_studied" class="w-full bg-slate-900 border border-slate-700 text-white rounded-md p-3 focus:ring-2 focus:ring-purple-500 focus:border-purple-500 transition"></div>
                                        <div><label class="block mb-2 text-sm font-medium">Madrasa Class/Level Studied</label><input type="text" x-model="editablePatient.madrasa_class_studied" class="w-full bg-slate-900 border border-slate-700 text-white rounded-md p-3 focus:ring-2 focus:ring-purple-500 focus:border-purple-500 transition"></div>
                                    </div>
                                </div>
                                <div class="p-6 bg-slate-800 rounded-lg border border-slate-700 space-y-6">
                                    <h3 class="text-xl font-bold text-white border-b border-slate-600 pb-3 mb-6">Marital & Family Status</h3>
                                    <div class="flex items-center space-x-3"><input type="checkbox" id="edit_is_married" x-model="editablePatient.is_married" class="h-4 w-4 rounded bg-slate-900 border-slate-700 text-purple-600 focus:ring-purple-500"><label for="edit_is_married">Is Married?</label></div>
                                    <div x-show="editablePatient.is_married" class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                        <div><label class="block mb-2 text-sm font-medium">Husband's Name</label><input type="text" x-model="editablePatient.husband_name" class="w-full bg-slate-900 border border-slate-700 text-white rounded-md p-3 focus:ring-2 focus:ring-purple-500 focus:border-purple-500 transition"></div>
                                        <div><label class="block mb-2 text-sm font-medium">Husband's Job</label><input type="text" x-model="editablePatient.husband_job" class="w-full bg-slate-900 border border-slate-700 text-white rounded-md p-3 focus:ring-2 focus:ring-purple-500 focus:border-purple-500 transition"></div>
                                    </div>
                                    <div><label class="block mb-2 text-sm font-medium">Number of Kids</label><input type="number" x-model.number="editablePatient.kids_count" @input="updateKidsArray()" class="w-full max-w-xs bg-slate-900 border border-slate-700 text-white rounded-md p-3 focus:ring-2 focus:ring-purple-500 focus:border-purple-500 transition"></div>
                                    <div x-show="editablePatient.kids_count > 0" class="space-y-3">
                                        <h4 class="text-sm font-semibold text-slate-300">Kid Details</h4>
                                        <template x-for="(kid, index) in editablePatient.kids" :key="index">
                                            <div class="flex items-center gap-4 p-3 bg-slate-900/50 rounded-md">
                                                <span class="font-medium text-slate-300">Kid <span x-text="index + 1"></span>:</span>
                                                <select x-model="kid.sex" class="w-1/3 bg-slate-800 border border-slate-700 text-white rounded-md p-2 focus:ring-2 focus:ring-purple-500 focus:border-purple-500 transition"><option value="">Sex...</option><option value="Male">Male</option><option value="Female">Female</option></select>
                                                <input type="number" x-model.number="kid.age" placeholder="Age" class="w-1/3 bg-slate-800 border border-slate-700 text-white rounded-md p-2 focus:ring-2 focus:ring-purple-500 focus:border-purple-500 transition">
                                            </div>
                                        </template>
                                    </div>
                                </div>
                                <div class="p-6 bg-slate-800 rounded-lg border border-slate-700 space-y-6">
                                    <h3 class="text-xl font-bold text-white border-b border-slate-600 pb-3 mb-6">Clinical & Other Information</h3>
                                    <div class="grid grid-cols-1 md:grid-cols-2 gap-x-8 gap-y-6">
                                        <div class="space-y-4">
                                            <div class="flex items-center space-x-3"><input type="checkbox" id="edit_is_working" x-model="editablePatient.is_working" class="h-4 w-4 rounded bg-slate-900 border-slate-700 text-purple-600 focus:ring-purple-500"><label for="edit_is_working">Is currently working?</label></div>
                                            <div class="flex items-center space-x-3"><input type="checkbox" id="edit_has_siblings" x-model="editablePatient.has_siblings" class="h-4 w-4 rounded bg-slate-900 border-slate-700 text-purple-600 focus:ring-purple-500"><label for="edit_has_siblings">Has siblings?</label></div>
                                            <div x-show="editablePatient.has_siblings" class="flex items-center space-x-3 ml-6"><input type="checkbox" id="edit_siblings_have_issues" x-model="editablePatient.siblings_have_issues" class="h-4 w-4 rounded bg-slate-900 border-slate-700 text-purple-600 focus:ring-purple-500"><label for="edit_siblings_have_issues">Do they have similar issues?</label></div>
                                            <div class="flex items-center space-x-3"><input type="checkbox" id="edit_is_genetic" x-model="editablePatient.is_genetic" class="h-4 w-4 rounded bg-slate-900 border-slate-700 text-purple-600 focus:ring-purple-500"><label for="edit_is_genetic">Is it genetic?</label></div>
                                            <div x-show="editablePatient.is_genetic" class="ml-6"><label class="block mb-2 text-sm font-medium">Name of relative with genetic link</label><input type="text" x-model="editablePatient.genetic_relative_name" class="w-full bg-slate-900 border border-slate-700 text-white rounded-md p-3 focus:ring-2 focus:ring-purple-500 focus:border-purple-500 transition"></div>
                                        </div>
                                        <div class="space-y-6">
                                            <div><label class="block mb-2 text-sm font-medium">Core Reason (e.g., OCD, Anxiety)</label><input type="text" x-model="editablePatient.core_reason" class="w-full bg-slate-900 border border-slate-700 text-white rounded-md p-3 focus:ring-2 focus:ring-purple-500 focus:border-purple-500 transition"></div>
                                            <div><label class="block mb-2 text-sm font-medium">When it started?</label><input type="text" x-model="editablePatient.when_it_started" class="w-full bg-slate-900 border border-slate-700 text-white rounded-md p-3 focus:ring-2 focus:ring-purple-500 focus:border-purple-500 transition"></div>
                                            <div>
                                                <label class="block mb-2 text-sm font-medium">Previously sought help from?</label>
                                                <div class="space-y-3 mt-2">
                                                    <div class="flex gap-4 flex-wrap"><label class="flex items-center gap-2"><input type="checkbox" value="Psychologist" x-model="editablePatient.previously_sought_help" class="h-4 w-4 rounded bg-slate-900 border-slate-700 text-purple-600 focus:ring-purple-500"> Psychologist</label><label class="flex items-center gap-2"><input type="checkbox" value="Psychiatrist" x-model="editablePatient.previously_sought_help" class="h-4 w-4 rounded bg-slate-900 border-slate-700 text-purple-600 focus:ring-purple-500"> Psychiatrist</label><label class="flex items-center gap-2"><input type="checkbox" value="Spiritual" x-model="editablePatient.previously_sought_help" class="h-4 w-4 rounded bg-slate-900 border-slate-700 text-purple-600 focus:ring-purple-500"> Spiritual</label></div>
                                                    <div><label class="block mb-2 text-sm font-medium">Other:</label><input type="text" x-model="editablePatient.previously_sought_help_other" class="w-full bg-slate-900 border border-slate-700 text-white rounded-md p-3 focus:ring-2 focus:ring-purple-500 focus:border-purple-500 transition"></div>
                                                </div>
                                            </div>
                                            <div><label class="block mb-2 text-sm font-medium">Medicine Status</label><select x-model="editablePatient.medicine_status" class="w-full bg-slate-900 border border-slate-700 text-white rounded-md p-3 focus:ring-2 focus:ring-purple-500 focus:border-purple-500 transition"><option value="">Select...</option><option value="I did take medicine">I did take medicine</option><option value="I am taking medicine now">I am taking medicine now</option></select></div>
                                            <div><label class="block mb-2 text-sm font-medium">Other Medications</label><input type="text" x-model="editablePatient.other_medications" class="w-full bg-slate-900 border border-slate-700 text-white rounded-md p-3 focus:ring-2 focus:ring-purple-500 focus:border-purple-500 transition"></div>
                                            <div><label class="block mb-2 text-sm font-medium">Other Diseases</label><input type="text" x-model="editablePatient.other_diseases" class="w-full bg-slate-900 border border-slate-700 text-white rounded-md p-3 focus:ring-2 focus:ring-purple-500 focus:border-purple-500 transition"></div>
                                        </div>
                                    </div>
                                </div>
                                <div class="flex justify-end gap-4 pt-4">
                                    <button type="button" @click="setView('allPatients')" class="px-4 py-2 rounded-md font-semibold transition-all duration-200 bg-slate-700 text-slate-300 hover:bg-slate-600">Cancel</button>
                                    <button type="submit" class="px-6 py-2 rounded-md font-semibold transition-all duration-300 text-white bg-gradient-to-r from-purple-600 to-indigo-600 hover:from-purple-700 hover:to-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-offset-slate-900 focus:ring-purple-500 hover:shadow-lg hover:shadow-purple-500/40">Save Changes</button>
                                </div>
                            </form>
                        </div>
                        
                        <div x-show="patientDetailTab === 'issues'">
                             <form @submit.prevent="updatePatientDetails" class="space-y-8" x-if="editablePatient && editablePatient.core_issues">
                                <div class="p-6 bg-slate-800 rounded-lg border border-slate-700 space-y-6">
                                    <h3 class="text-xl font-bold text-white border-b border-slate-600 pb-3 mb-6">Core Issues Checklist</h3>
                                    <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                                        <div class="space-y-6">
                                            <div class="flex items-center space-x-3"><input type="checkbox" id="core_belief" x-model="editablePatient.core_issues.is_about_belief" class="h-4 w-4 rounded bg-slate-900 border-slate-700 text-purple-600 focus:ring-purple-500"><label for="core_belief">Is it about belief?</label></div>
                                            <div>
                                                <label class="font-semibold">Niyyath (Intention) related:</label>
                                                <div class="flex gap-4 flex-wrap mt-2"><label class="flex items-center gap-2"><input type="checkbox" value="Wudu" x-model="editablePatient.core_issues.niyyath_related" class="h-4 w-4 rounded bg-slate-900 border-slate-700 text-purple-600 focus:ring-purple-500"> Wudu</label><label class="flex items-center gap-2"><input type="checkbox" value="Namaz" x-model="editablePatient.core_issues.niyyath_related" class="h-4 w-4 rounded bg-slate-900 border-slate-700 text-purple-600 focus:ring-purple-500"> Namaz</label><label class="flex items-center gap-2"><input type="checkbox" value="Ghusl" x-model="editablePatient.core_issues.niyyath_related" class="h-4 w-4 rounded bg-slate-900 border-slate-700 text-purple-600 focus:ring-purple-500"> Ghusl</label><label class="flex items-center gap-2"><input type="checkbox" value="Fasting" x-model="editablePatient.core_issues.niyyath_related" class="h-4 w-4 rounded bg-slate-900 border-slate-700 text-purple-600 focus:ring-purple-500"> Fasting</label></div>
                                            </div>
                                            <div><label class="font-semibold block mb-2">Wudu (Ablution) related:</label><input type="text" placeholder="Wudu time (e.g., 30 mins)" x-model="editablePatient.core_issues.wudu_time" class="w-full bg-slate-900 border border-slate-700 text-white rounded-md p-3 focus:ring-2 focus:ring-purple-500 focus:border-purple-500 transition"></div>
                                            <div><label class="font-semibold block mb-2">Namaz (Prayer) related:</label><input type="text" placeholder="Namaz time (e.g., 45 mins)" x-model="editablePatient.core_issues.namaz_time" class="w-full bg-slate-900 border border-slate-700 text-white rounded-md p-3 focus:ring-2 focus:ring-purple-500 focus:border-purple-500 transition"></div>
                                            <div>
                                                <label class="font-semibold">Najas (Impurity) related:</label>
                                                <div class="grid grid-cols-2 gap-3 mt-2"><label class="flex items-center gap-2"><input type="checkbox" value="Urination time" x-model="editablePatient.core_issues.najas_related" class="h-4 w-4 rounded bg-slate-900 border-slate-700 text-purple-600 focus:ring-purple-500"> Urination time</label><label class="flex items-center gap-2"><input type="checkbox" value="Motion time" x-model="editablePatient.core_issues.najas_related" class="h-4 w-4 rounded bg-slate-900 border-slate-700 text-purple-600 focus:ring-purple-500"> Motion time</label><label class="flex items-center gap-2"><input type="checkbox" value="Ghusl time" x-model="editablePatient.core_issues.najas_related" class="h-4 w-4 rounded bg-slate-900 border-slate-700 text-purple-600 focus:ring-purple-500"> Ghusl time</label><label class="flex items-center gap-2"><input type="checkbox" value="Normal bath time" x-model="editablePatient.core_issues.najas_related" class="h-4 w-4 rounded bg-slate-900 border-slate-700 text-purple-600 focus:ring-purple-500"> Normal bath time</label><label class="flex items-center gap-2"><input type="checkbox" value="Hand washing time" x-model="editablePatient.core_issues.najas_related" class="h-4 w-4 rounded bg-slate-900 border-slate-700 text-purple-600 focus:ring-purple-500"> Hand washing time</label><label class="flex items-center gap-2"><input type="checkbox" value="Dress washing time" x-model="editablePatient.core_issues.najas_related" class="h-4 w-4 rounded bg-slate-900 border-slate-700 text-purple-600 focus:ring-purple-500"> Dress washing time</label></div>
                                            </div>
                                        </div>
                                        <div class="space-y-6">
                                             <div>
                                                <label class="font-semibold">Object/Animal related:</label>
                                                <div class="space-y-3 mt-2"><label class="flex items-center gap-2"><input type="checkbox" id="core_dog" x-model="editablePatient.core_issues.dog_related" class="h-4 w-4 rounded bg-slate-900 border-slate-700 text-purple-600 focus:ring-purple-500"> Dog related</label><label class="flex items-center gap-2"><input type="checkbox" id="core_pig" x-model="editablePatient.core_issues.pig_related" class="h-4 w-4 rounded bg-slate-900 border-slate-700 text-purple-600 focus:ring-purple-500"> Pig related</label><label class="flex items-center gap-2"><input type="checkbox" id="core_soap" x-model="editablePatient.core_issues.over_soaping" class="h-4 w-4 rounded bg-slate-900 border-slate-700 text-purple-600 focus:ring-purple-500"> Over-soaping</label></div>
                                            </div>
                                            <div>
                                                <label class="font-semibold">Fear related:</label>
                                                <div class="space-y-3 mt-2"><label class="flex items-center gap-2"><input type="checkbox" id="core_death" x-model="editablePatient.core_issues.fear_of_death" class="h-4 w-4 rounded bg-slate-900 border-slate-700 text-purple-600 focus:ring-purple-500"> Fear of death</label><label class="flex items-center gap-2"><input type="checkbox" id="core_disease" x-model="editablePatient.core_issues.fear_of_disease" class="h-4 w-4 rounded bg-slate-900 border-slate-700 text-purple-600 focus:ring-purple-500"> Fear of disease</label><label class="flex items-center gap-2"><input type="checkbox" id="core_door" x-model="editablePatient.core_issues.door_locking_related" class="h-4 w-4 rounded bg-slate-900 border-slate-700 text-purple-600 focus:ring-purple-500"> Door locking related</label></div>
                                            </div>
                                            <div><label class="font-semibold block mb-2">Other Issues:</label><textarea x-model="editablePatient.core_issues.other_issues" class="w-full bg-slate-900 border border-slate-700 text-white rounded-md p-3 focus:ring-2 focus:ring-purple-500 focus:border-purple-500 transition" rows="5"></textarea></div>
                                        </div>
                                    </div>
                                </div>
                                <div class="flex justify-end"><button type="submit" class="px-6 py-2 rounded-md font-semibold transition-all duration-300 text-white bg-gradient-to-r from-purple-600 to-indigo-600 hover:from-purple-700 hover:to-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-offset-slate-900 focus:ring-purple-500 hover:shadow-lg hover:shadow-purple-500/40">Save Checklist</button></div>
                             </form>
                        </div>

                        <div x-show="patientDetailTab === 'sessions'">
                            <div class="flex justify-end mb-6"><button @click="openSessionModal('add')" class="px-6 py-2 rounded-md font-semibold transition-all duration-300 text-white bg-gradient-to-r from-purple-600 to-indigo-600 hover:from-purple-700 hover:to-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-offset-slate-900 focus:ring-purple-500 hover:shadow-lg hover:shadow-purple-500/40">Add Session</button></div>
                            <div class="space-y-6">
                                <template x-for="session in selectedPatient.sessions" :key="session.id">
                                    <div class="p-6 bg-slate-800 rounded-lg border border-slate-700">
                                        <div class="flex justify-between items-start mb-4">
                                            <div><h4 class="text-lg font-bold" x-text="session.title"></h4><span class="text-sm text-slate-400" x-text="formatDate(session.date)"></span></div>
                                            <button @click="openSessionModal('edit', session)" class="px-3 py-1 rounded-md font-semibold transition-all duration-200 bg-slate-700 text-slate-300 hover:bg-slate-600 text-xs">Edit</button>
                                        </div>
                                        <p class="text-slate-300 whitespace-pre-wrap" x-text="session.log"></p>
                                    </div>
                                </template>
                                <template x-if="!selectedPatient.sessions || selectedPatient.sessions.length === 0"><div class="text-center py-10 text-slate-400 bg-slate-800 rounded-lg border border-slate-700"><p>No sessions recorded.</p></div></template>
                            </div>
                        </div>

                        <div x-show="patientDetailTab === 'progress'">
                            <div class="p-6 bg-slate-800 rounded-lg border border-slate-700 space-y-6">
                                <h3 class="text-xl font-bold text-white border-b border-slate-600 pb-3 mb-6">Progress Tracking</h3>
                                <div class="space-y-5">
                                    <template x-for="issue in editablePatient.tracked_issues" :key="issue.id">
                                        <div class="flex items-center gap-4">
                                            <div class="flex-grow"><div class="flex justify-between text-sm mb-1"><span x-text="issue.name"></span><span x-text="issue.percentage_cured + '% Cured'"></span></div><div class="w-full bg-slate-700 rounded-full h-2.5"><div class="bg-purple-600 h-2.5 rounded-full" :style="`width: ${issue.percentage_cured}%`"></div></div></div>
                                            <input type="number" min="0" max="100" x-model.number="issue.percentage_cured" @change.debounce.500ms="updateTrackedIssue(issue)" class="w-20 bg-slate-900 border border-slate-700 text-white rounded-md p-1 text-center">
                                            <button @click="deleteTrackedIssue(issue.id)" class="text-red-400 hover:text-red-300 font-bold text-2xl leading-none">&times;</button>
                                        </div>
                                    </template>
                                    <template x-if="!editablePatient.tracked_issues || editablePatient.tracked_issues.length === 0"><p class="text-center py-4 text-slate-400">No issues are being tracked. Add one below.</p></template>
                                </div>
                                <div class="pt-6 border-t border-slate-700">
                                    <form @submit.prevent="addTrackedIssue" class="flex items-end gap-4">
                                        <div class="flex-grow"><label class="block mb-2 text-sm font-medium">New Issue to Track</label><input type="text" x-model="newTrackedIssue.name" required placeholder="e.g., Reduce hand washing" class="w-full bg-slate-900 border border-slate-700 text-white rounded-md p-2 focus:ring-2 focus:ring-purple-500 focus:border-purple-500 transition"></div>
                                        <div><label class="block mb-2 text-sm font-medium">Initial %</label><input type="number" min="0" max="100" x-model.number="newTrackedIssue.percentage_cured" required class="w-24 bg-slate-900 border border-slate-700 text-white rounded-md p-2 focus:ring-2 focus:ring-purple-500 focus:border-purple-500 transition"></div>
                                        <button type="submit" class="h-10 px-4 rounded-md font-semibold transition-all duration-300 text-white bg-gradient-to-r from-purple-600 to-indigo-600 hover:from-purple-700 hover:to-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-offset-slate-900 focus:ring-purple-500 hover:shadow-lg hover:shadow-purple-500/40">Add</button>
                                    </form>
                                </div>
                            </div>
                        </div>
                    </div>
                </template>
            </main>

             <main x-show="currentView === 'schedule'" x-init="if(isAuthenticated) getSchedule()">
                <h1 class="text-3xl font-bold text-white mb-8">Schedule</h1>
                 <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                    <div class="lg:col-span-1">
                        <div class="p-6 bg-slate-800 rounded-lg border border-slate-700">
                             <h3 class="text-xl font-bold text-white mb-6">Add Appointment</h3>
                             <form @submit.prevent="addScheduleEvent" class="space-y-4">
                                <div><label class="block mb-2 text-sm font-medium">Name / Title</label><input type="text" x-model="newScheduleEvent.title" required class="w-full bg-slate-900 border border-slate-700 text-white rounded-md p-3 focus:ring-2 focus:ring-purple-500 focus:border-purple-500 transition"></div>
                                <div><label class="block mb-2 text-sm font-medium">Appointment Time</label><input type="datetime-local" x-model="newScheduleEvent.time" required class="w-full bg-slate-900 border border-slate-700 text-white rounded-md p-3 focus:ring-2 focus:ring-purple-500 focus:border-purple-500 transition"></div>
                                <button type="submit" class="w-full px-4 py-3 rounded-md font-semibold transition-all duration-300 text-white bg-gradient-to-r from-purple-600 to-indigo-600 hover:from-purple-700 hover:to-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-offset-slate-900 focus:ring-purple-500 hover:shadow-lg hover:shadow-purple-500/40">Add Event</button>
                             </form>
                        </div>
                    </div>
                    <div class="lg:col-span-2">
                        <div class="bg-slate-800 rounded-lg border border-slate-700 overflow-x-auto">
                            <table class="w-full text-sm text-left text-slate-300">
                                <thead class="text-xs text-slate-400 uppercase bg-slate-700"><tr><th scope="col" class="px-6 py-3">Title</th><th scope="col" class="px-6 py-3">Time</th><th scope="col" class="px-6 py-3">Status</th><th scope="col" class="px-6 py-3 text-right">Actions</th></tr></thead>
                                <tbody>
                                    <template x-for="event in schedule" :key="event.id">
                                         <tr class="border-b border-slate-700">
                                            <td class="px-6 py-4 font-medium text-white" x-text="event.title"></td>
                                            <td class="px-6 py-4" x-text="formatDateTime(event.time)"></td>
                                            <td class="px-6 py-4"><span class="px-2 py-1 text-xs font-medium rounded-full" :class="{'bg-blue-900 text-blue-300': event.status === 'Scheduled', 'bg-green-900 text-green-300': event.status === 'Completed', 'bg-yellow-900 text-yellow-300': event.status === 'Canceled'}" x-text="event.status"></span></td>
                                            <td class="px-6 py-4 text-right">
                                                <div class="flex gap-2 justify-end">
                                                    <template x-if="event.status === 'Scheduled'"><button @click="updateScheduleStatus(event.id, 'Completed')" class="px-2 py-1 text-xs rounded bg-green-500/20 text-green-300 hover:bg-green-500/40">Complete</button><button @click="updateScheduleStatus(event.id, 'Canceled')" class="px-2 py-1 text-xs rounded bg-yellow-500/20 text-yellow-300 hover:bg-yellow-500/40">Cancel</button></template>
                                                    <button @click="deleteScheduleEvent(event.id)" class="px-2 py-1 text-xs rounded bg-red-500/20 text-red-300 hover:bg-red-500/40">Delete</button>
                                                </div>
                                            </td>
                                         </tr>
                                    </template>
                                     <template x-if="schedule.length === 0"><tr><td colspan="4" class="text-center py-8 text-slate-400">No events scheduled.</td></tr></template>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <div x-show="deletePatientModal.show" class="fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-75" @click.self="deletePatientModal.show = false">
        <div class="bg-slate-800 rounded-lg p-6 w-full max-w-md border border-slate-700"><h3 class="text-lg font-bold text-white">Confirm Deletion</h3><p class="mt-2 text-slate-300">Are you sure you want to delete the patient "<span x-text="deletePatientModal.name"></span>"? This action cannot be undone.</p><div class="mt-6 flex justify-end gap-4"><button @click="deletePatientModal.show = false" class="px-4 py-2 rounded-md font-semibold transition-all duration-200 bg-slate-700 text-slate-300 hover:bg-slate-600">Cancel</button><button @click="deletePatient()" class="px-4 py-2 rounded-md font-semibold transition-all duration-200 bg-red-600 text-white hover:bg-red-700">Delete</button></div></div>
    </div>

    <div x-show="sessionModal.show" class="fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-75" @click.self="sessionModal.show = false">
        <div class="bg-slate-800 rounded-lg p-6 w-full max-w-2xl border border-slate-700 max-h-[90vh] overflow-y-auto">
            <h3 class="text-xl font-bold text-white mb-6" x-text="sessionModal.mode === 'add' ? 'Add New Session' : 'Edit Session'"></h3>
            <form @submit.prevent="saveSession" class="space-y-6">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div><label class="block mb-2 text-sm font-medium">Title</label><input type="text" x-model="sessionModal.data.title" required class="w-full bg-slate-900 border border-slate-700 text-white rounded-md p-3 focus:ring-2 focus:ring-purple-500 focus:border-purple-500 transition"></div>
                    <div><label class="block mb-2 text-sm font-medium">Date</label><input type="date" x-model="sessionModal.data.date" required class="w-full bg-slate-900 border border-slate-700 text-white rounded-md p-3 focus:ring-2 focus:ring-purple-500 focus:border-purple-500 transition"></div>
                </div>
                <div><label class="block mb-2 text-sm font-medium">Session Log / Description</label><textarea x-model="sessionModal.data.log" required class="w-full bg-slate-900 border border-slate-700 text-white rounded-md p-3 focus:ring-2 focus:ring-purple-500 focus:border-purple-500 transition" rows="8"></textarea></div>
                <div class="mt-8 flex justify-end gap-4">
                    <button type="button" @click="sessionModal.show = false" class="px-4 py-2 rounded-md font-semibold transition-all duration-200 bg-slate-700 text-slate-300 hover:bg-slate-600">Cancel</button>
                    <button type="submit" class="px-6 py-2 rounded-md font-semibold transition-all duration-300 text-white bg-gradient-to-r from-purple-600 to-indigo-600 hover:from-purple-700 hover:to-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-offset-slate-900 focus:ring-purple-500 hover:shadow-lg hover:shadow-purple-500/40">Save Session</button>
                </div>
            </form>
        </div>
    </div>

    <script>
    function clinicApp() {
        return {
            isAuthenticated: localStorage.getItem('accessToken') ? true : false,
            credentials: { username: '', password: '' },
            loginError: '',
            currentView: 'dashboard',
            sidebarOpen: false,
            patients: [],
            patientSearch: '',
            dashboard: { total_patients: 0, upcoming_appointments: 0, recent_patient_visits: [] },
            schedule: [],
            newScheduleEvent: { title: '', time: '' },
            selectedPatient: null,
            editablePatient: null,
            patientDetailTab: 'details',
            deletePatientModal: { show: false, id: null, name: ''},
            notification: { show: false, message: '', type: 'success' },
            sessionModal: { show: false, mode: 'add', data: {} },
            newTrackedIssue: { name: '', percentage_cured: 0 },

          
            get filteredPatients() {
                if (!this.patientSearch.trim()) return this.patients;
                const search = this.patientSearch.toLowerCase();
                return this.patients.filter(p => 
                    (p.full_name && p.full_name.toLowerCase().includes(search)) || 
                    (p.phone_number && p.phone_number.includes(search))
                );
            },
            
            init() {
                this.resetEditablePatient();
                if (this.isAuthenticated) { this.setView('dashboard'); }
            },
            
            async apiCall(url, method = 'GET', body = null) {
                const headers = { 'Content-Type': 'application/json', 'Authorization': `Bearer ${localStorage.getItem('accessToken')}`};
                const options = { method, headers };
                if (body) { options.body = JSON.stringify(body); }
                try {
                    const response = await fetch(url, options);
                    if (response.status === 401) { this.logout(); return null; }
                    if (!response.ok) {
                        const errorData = await response.json();
                        let errorMessage = 'An API error occurred.';
                        if (errorData.detail) {
                            if (Array.isArray(errorData.detail)) {
                                errorMessage = errorData.detail.map(e => e.msg).join(', ');
                            } else if (typeof errorData.detail === 'string') {
                                errorMessage = errorData.detail;
                            }
                        }
                        throw new Error(errorMessage);
                    }
                    if (response.status === 204) return true;
                    return await response.json();
                } catch (error) {
                    this.showNotification(error.message, 'error');
                    console.error('API Call Error:', error);
                    return null;
                }
            },
            
            async login() {
                this.loginError = '';
                const formData = new URLSearchParams();
                formData.append('username', this.credentials.username);
                formData.append('password', this.credentials.password);
                try {
                    const response = await fetch('/token', { method: 'POST', body: formData });
                    if (!response.ok) { const errorData = await response.json(); throw new Error(errorData.detail); }
                    const data = await response.json();
                    localStorage.setItem('accessToken', data.access_token);
                    this.isAuthenticated = true;
                    this.setView('dashboard');
                } catch (error) { this.loginError = error.message; }
            },
            logout() {
                localStorage.removeItem('accessToken');
                this.isAuthenticated = false;
                this.currentView = '';
            },

            setView(view) {
                this.currentView = view;
                this.sidebarOpen = false;
                if(view === 'addPatient') {
                    this.resetEditablePatient();
                }
                if (this.isAuthenticated && !this.selectedPatient) { // Avoid refetching patient data on tab switch
                    if (view === 'dashboard') this.getDashboardStats();
                    if (view === 'allPatients') this.getAllPatients();
                    if (view === 'schedule') this.getSchedule();
                }
            },
            
            async refreshPatientData(id) {
                const data = await this.apiCall(`/api/patients/${id}`);
                if (data) {
                    this.selectedPatient = data;
                    this.editablePatient = JSON.parse(JSON.stringify(data));
                    // --- BUG FIX: Robustly initialize nested objects and arrays ---
                    if (!this.editablePatient.core_issues) { this.editablePatient.core_issues = {}; }
                    if (!Array.isArray(this.editablePatient.core_issues.niyyath_related)) { this.editablePatient.core_issues.niyyath_related = []; }
                    if (!Array.isArray(this.editablePatient.core_issues.najas_related)) { this.editablePatient.core_issues.najas_related = []; }
                    if (!Array.isArray(this.editablePatient.kids)) { this.editablePatient.kids = []; }
                    if (!Array.isArray(this.editablePatient.tracked_issues)) { this.editablePatient.tracked_issues = []; }
                }
            },

            async getDashboardStats() {
                const data = await this.apiCall('/api/dashboard-stats');
                if (data) this.dashboard = data;
            },

            async getAllPatients() {
                const data = await this.apiCall('/api/patients');
                if (data) this.patients = data;
            },
            async addPatient() {
                const data = await this.apiCall('/api/patients', 'POST', this.editablePatient);
                if (data) {
                    this.showNotification('Patient added successfully!', 'success');
                    this.setView('allPatients');
                }
            },
            async viewPatient(id) {
                await this.refreshPatientData(id);
                if(this.selectedPatient){
                    this.patientDetailTab = 'details';
                    this.currentView = 'patientDetail';
                }
            },
            async updatePatientDetails() {
                const data = await this.apiCall(`/api/patients/${this.selectedPatient.id}`, 'PUT', this.editablePatient);
                if (data) {
                    this.showNotification('Patient details updated!', 'success');
                    await this.refreshPatientData(this.selectedPatient.id); 
                }
            },
            confirmDeletePatient(id, name) {
                this.deletePatientModal = { show: true, id, name };
            },
            async deletePatient() {
                if (await this.apiCall(`/api/patients/${this.deletePatientModal.id}`, 'DELETE')) {
                    this.showNotification('Patient deleted.', 'success');
                    this.deletePatientModal.show = false;
                    this.setView('allPatients');
                }
            },
            
            resetEditablePatient() {
                this.editablePatient = {
                    full_name: '', phone_number: '', age: null, place: '', father_name: '', school_class_studied: '', madrasa_class_studied: '',
                    is_married: false, husband_name: '', husband_job: '', kids_count: 0, kids: [],
                    is_working: false, has_siblings: false, siblings_have_issues: false,
                    core_reason: '', when_it_started: '', previously_sought_help: [], previously_sought_help_other: '',
                    medicine_status: '', other_medications: '', other_diseases: '',
                    is_genetic: false, genetic_relative_name: ''
                };
            },
            updateKidsArray() {
                const count = this.editablePatient.kids_count || 0;
                while (this.editablePatient.kids.length < count) { this.editablePatient.kids.push({ sex: '', age: null }); }
                if (this.editablePatient.kids.length > count) { this.editablePatient.kids.length = count; }
            },
            
            openSessionModal(mode, session = null) {
                this.sessionModal.mode = mode;
                this.sessionModal.data = (mode === 'add') 
                    ? { title: '', date: new Date().toISOString().split('T')[0], log: '' }
                    : JSON.parse(JSON.stringify(session));
                this.sessionModal.show = true;
            },
            async saveSession() {
                let success = false;
                if (this.sessionModal.mode === 'add') {
                    if (await this.apiCall(`/api/patients/${this.selectedPatient.id}/sessions`, 'POST', this.sessionModal.data)) { 
                        this.showNotification('Session added!', 'success'); success = true; 
                    }
                } else {
                    if (await this.apiCall(`/api/sessions/${this.sessionModal.data.id}`, 'PUT', this.sessionModal.data)) { 
                        this.showNotification('Session updated!', 'success'); success = true; 
                    }
                }
                if (success) {
                    this.sessionModal.show = false;
                    this.refreshPatientData(this.selectedPatient.id);
                }
            },
            
            async addTrackedIssue() {
                if (await this.apiCall(`/api/patients/${this.selectedPatient.id}/issues`, 'POST', this.newTrackedIssue)) {
                    this.showNotification('Tracked issue added!', 'success');
                    this.newTrackedIssue = { name: '', percentage_cured: 0 };
                    this.refreshPatientData(this.selectedPatient.id);
                }
            },
            async updateTrackedIssue(issue) {
                if (await this.apiCall(`/api/issues/${issue.id}`, 'PUT', issue)) { 
                    this.showNotification(`'${issue.name}' updated.`, 'success');
                    this.refreshPatientData(this.selectedPatient.id);
                }
            },
            async deleteTrackedIssue(issueId) {
                if (confirm('Are you sure?')) {
                    if (await this.apiCall(`/api/issues/${issueId}`, 'DELETE')) {
                        this.showNotification('Issue deleted.', 'success');
                        this.refreshPatientData(this.selectedPatient.id);
                    }
                }
            },

            async getSchedule() {
                const data = await this.apiCall('/api/schedule');
                if(data) this.schedule = data;
            },
            async addScheduleEvent() {
                if (await this.apiCall('/api/schedule', 'POST', this.newScheduleEvent)) {
                    this.getSchedule();
                    this.newScheduleEvent = { title: '', time: '' };
                }
            },
            async updateScheduleStatus(id, status) {
                if (await this.apiCall(`/api/schedule/${id}`, 'PUT', { status })) { this.getSchedule(); }
            },
            async deleteScheduleEvent(id) {
                if (await this.apiCall(`/api/schedule/${id}`, 'DELETE')) { this.getSchedule(); }
            },
            
            formatDate(dateString) {
                if (!dateString) return '';
                const date = new Date(dateString);
                const userTimezoneOffset = date.getTimezoneOffset() * 60000;
                return new Date(date.getTime() + userTimezoneOffset).toLocaleDateString('en-GB', { day: 'numeric', month: 'long', year: 'numeric' });
            },
            formatDateTime(dateTimeString) {
                if (!dateTimeString) return '';
                return new Date(dateTimeString).toLocaleString('en-GB', { dateStyle: 'medium', timeStyle: 'short' });
            },
            showNotification(message, type = 'success') {
                this.notification.message = message;
                this.notification.type = type;
                this.notification.show = true;
                setTimeout(() => { this.notification.show = false; }, 3000);
            }
        }
    }
    </script>
</body>
</html>